-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.administradores_estabelecimento (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  usuario_id uuid,
  estabelecimento_id uuid,
  nivel_permissao text NOT NULL DEFAULT 'gerente'::text CHECK (nivel_permissao = ANY (ARRAY['proprietario'::text, 'gerente'::text, 'operador'::text])),
  permissoes jsonb DEFAULT '{"ver_financeiro": true, "gerenciar_admins": false, "gerenciar_pedidos": true, "gerenciar_cardapio": true, "gerenciar_entregadores": true, "configuracoes_avancadas": false}'::jsonb,
  ativo boolean DEFAULT true,
  convite_pendente boolean DEFAULT true,
  convidado_por uuid,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  updated_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  CONSTRAINT administradores_estabelecimento_pkey PRIMARY KEY (id),
  CONSTRAINT administradores_estabelecimento_usuario_id_fkey FOREIGN KEY (usuario_id) REFERENCES public.usuarios(id),
  CONSTRAINT administradores_estabelecimento_estabelecimento_id_fkey FOREIGN KEY (estabelecimento_id) REFERENCES public.estabelecimentos(id),
  CONSTRAINT administradores_estabelecimento_convidado_por_fkey FOREIGN KEY (convidado_por) REFERENCES public.usuarios(id)
);
CREATE TABLE public.clientes (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  usuario_id uuid UNIQUE,
  cpf text UNIQUE,
  data_nascimento date,
  foto_perfil_url text,
  preferencias jsonb DEFAULT '{"tema": "sistema", "notificacoes_push": true, "notificacoes_email": true}'::jsonb,
  total_pedidos integer DEFAULT 0,
  valor_total_gasto numeric DEFAULT 0,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  updated_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  CONSTRAINT clientes_pkey PRIMARY KEY (id),
  CONSTRAINT clientes_usuario_id_fkey FOREIGN KEY (usuario_id) REFERENCES public.usuarios(id)
);
CREATE TABLE public.enderecos_clientes (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  cliente_id uuid,
  apelido text,
  cep text NOT NULL,
  logradouro text NOT NULL,
  numero text NOT NULL,
  complemento text,
  bairro text NOT NULL,
  cidade text NOT NULL,
  estado text NOT NULL,
  latitude numeric NOT NULL,
  longitude numeric NOT NULL,
  ponto_referencia text,
  instrucoes_entrega text,
  is_padrao boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  updated_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  CONSTRAINT enderecos_clientes_pkey PRIMARY KEY (id),
  CONSTRAINT enderecos_clientes_cliente_id_fkey FOREIGN KEY (cliente_id) REFERENCES public.clientes(id)
);
CREATE TABLE public.entregadores (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  usuario_id uuid UNIQUE,
  cpf text NOT NULL UNIQUE,
  data_nascimento date,
  foto_perfil_url text,
  cnh_numero text UNIQUE,
  cnh_categoria text,
  cnh_validade date,
  cnh_foto_url text,
  tipo_veiculo text CHECK (tipo_veiculo = ANY (ARRAY['moto'::text, 'carro'::text, 'bicicleta'::text, 'van'::text])),
  veiculo_placa text,
  veiculo_modelo text,
  veiculo_cor text,
  veiculo_ano integer,
  veiculo_foto_url text,
  dados_bancarios jsonb DEFAULT '{"banco": null, "conta": null, "agencia": null, "pix_chave": null, "tipo_conta": null}'::jsonb,
  asaas_wallet_id text,
  asaas_account_id text,
  status_cadastro text DEFAULT 'pendente'::text,
  status_online boolean DEFAULT false,
  motivo_rejeicao text,
  raio_atuacao_km integer DEFAULT 10,
  aceita_pedidos_automaticamente boolean DEFAULT false,
  localizacao_atual jsonb,
  total_entregas integer DEFAULT 0,
  avaliacao_media numeric DEFAULT 5.0,
  total_avaliacoes integer DEFAULT 0,
  ganhos_total numeric DEFAULT 0,
  ganhos_disponiveis numeric DEFAULT 0,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  updated_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  CONSTRAINT entregadores_pkey PRIMARY KEY (id),
  CONSTRAINT entregadores_usuario_id_fkey FOREIGN KEY (usuario_id) REFERENCES public.usuarios(id)
);
CREATE TABLE public.estabelecimentos (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  usuario_id uuid,
  razao_social text,
  cnpj text UNIQUE,
  inscricao_estadual text,
  inscricao_municipal text,
  categoria text NOT NULL,
  subcategorias ARRAY,
  descricao text,
  logo_url text,
  banner_url text,
  fotos_estabelecimento ARRAY,
  telefone_comercial text,
  whatsapp text,
  email_comercial text,
  endereco jsonb NOT NULL,
  horario_funcionamento jsonb DEFAULT '{"dom": {"aberto": false}, "qua": {"fim": "20:00", "aberto": true, "inicio": "06:00"}, "qui": {"fim": "20:00", "aberto": true, "inicio": "06:00"}, "sab": {"fim": "19:00", "aberto": true, "inicio": "07:00"}, "seg": {"fim": "20:00", "aberto": true, "inicio": "06:00"}, "sex": {"fim": "20:00", "aberto": true, "inicio": "06:00"}, "ter": {"fim": "20:00", "aberto": true, "inicio": "06:00"}}'::jsonb,
  config_entrega jsonb DEFAULT '{"taxa_por_km": 2.00, "pedido_minimo": 15.00, "raio_maximo_km": 8, "gratis_acima_de": 50.00, "taxa_entrega_fixa": 5.00, "tempo_medio_preparo_min": 30}'::jsonb,
  asaas_wallet_id text,
  asaas_account_id text,
  status_cadastro text DEFAULT 'pendente'::text,
  status_aberto boolean DEFAULT false,
  motivo_suspensao text,
  documentos jsonb DEFAULT '{"contrato_social": null, "alvara_funcionamento": null, "comprovante_endereco": null}'::jsonb,
  total_pedidos integer DEFAULT 0,
  faturamento_total numeric DEFAULT 0,
  avaliacao_media numeric DEFAULT 5.0,
  total_avaliacoes integer DEFAULT 0,
  config_avancada jsonb DEFAULT '{"aceita_agendamento": false, "tempo_maximo_entrega_min": 60, "tempo_minimo_entrega_min": 15, "intervalo_atualizacao_estoque_min": 5, "tempo_antecedencia_agendamento_min": 60}'::jsonb,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  updated_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  responsavel_nome text,
  responsavel_cpf text,
  dados_bancarios jsonb DEFAULT '{"banco": null, "conta": null, "agencia": null, "titular": null, "tipo_conta": null, "conta_digito": null}'::jsonb,
  CONSTRAINT estabelecimentos_pkey PRIMARY KEY (id),
  CONSTRAINT estabelecimentos_usuario_id_fkey FOREIGN KEY (usuario_id) REFERENCES public.usuarios(id)
);
CREATE TABLE public.historico_status_pedido (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  pedido_id uuid,
  status_anterior text,
  status_novo text NOT NULL,
  alterado_por uuid,
  motivo text,
  metadata jsonb,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  CONSTRAINT historico_status_pedido_pkey PRIMARY KEY (id),
  CONSTRAINT historico_status_pedido_pedido_id_fkey FOREIGN KEY (pedido_id) REFERENCES public.pedidos(id),
  CONSTRAINT historico_status_pedido_alterado_por_fkey FOREIGN KEY (alterado_por) REFERENCES public.usuarios(id)
);
CREATE TABLE public.pedidos (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  cliente_id uuid,
  estabelecimento_id uuid,
  entregador_id uuid,
  endereco_entrega_id uuid,
  status text DEFAULT 'pendente'::text CHECK (status = ANY (ARRAY['pendente'::text, 'confirmado'::text, 'preparando'::text, 'pronto'::text, 'em_entrega'::text, 'entregue'::text, 'cancelado_cliente'::text, 'cancelado_estab'::text, 'cancelado_sistema'::text])),
  itens jsonb NOT NULL,
  subtotal_produtos numeric NOT NULL,
  taxa_entrega numeric NOT NULL,
  taxa_servico_app numeric NOT NULL,
  desconto_cupom numeric DEFAULT 0,
  total numeric NOT NULL,
  endereco_entrega_snapshot jsonb NOT NULL,
  distancia_km numeric,
  tempo_estimado_preparo_min integer,
  tempo_estimado_entrega_min integer,
  asaas_payment_id text,
  asaas_invoice_url text,
  pagamento_metodo text CHECK (pagamento_metodo = ANY (ARRAY['pix'::text, 'cartao_credito'::text, 'cartao_debito'::text, 'boleto'::text, 'dinheiro'::text])),
  pagamento_status text DEFAULT 'pendente'::text,
  split_processado boolean DEFAULT false,
  localizacao_entregador jsonb,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  confirmado_em timestamp with time zone,
  preparando_em timestamp with time zone,
  pronto_em timestamp with time zone,
  em_entrega_em timestamp with time zone,
  entregue_em timestamp with time zone,
  cancelado_em timestamp with time zone,
  motivo_cancelamento text,
  avaliacao_cliente jsonb,
  avaliacao_entregador jsonb,
  updated_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  CONSTRAINT pedidos_pkey PRIMARY KEY (id),
  CONSTRAINT pedidos_cliente_id_fkey FOREIGN KEY (cliente_id) REFERENCES public.clientes(id),
  CONSTRAINT pedidos_estabelecimento_id_fkey FOREIGN KEY (estabelecimento_id) REFERENCES public.estabelecimentos(id),
  CONSTRAINT pedidos_entregador_id_fkey FOREIGN KEY (entregador_id) REFERENCES public.entregadores(id),
  CONSTRAINT pedidos_endereco_entrega_id_fkey FOREIGN KEY (endereco_entrega_id) REFERENCES public.enderecos_clientes(id)
);
CREATE TABLE public.produtos (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  estabelecimento_id uuid,
  nome text NOT NULL,
  descricao text,
  categoria text NOT NULL,
  preco numeric NOT NULL,
  preco_promocional numeric,
  custo_estimado numeric,
  foto_principal_url text,
  fotos_adicionais ARRAY,
  disponivel boolean DEFAULT true,
  destaque boolean DEFAULT false,
  opcoes jsonb DEFAULT '[]'::jsonb,
  controle_estoque boolean DEFAULT false,
  quantidade_estoque integer,
  tempo_preparo_adicional_min integer DEFAULT 0,
  total_vendidos integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  updated_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  CONSTRAINT produtos_pkey PRIMARY KEY (id),
  CONSTRAINT produtos_estabelecimento_id_fkey FOREIGN KEY (estabelecimento_id) REFERENCES public.estabelecimentos(id)
);
CREATE TABLE public.splits_pagamento (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  pedido_id uuid UNIQUE,
  valor_total numeric NOT NULL,
  estabelecimento_wallet_id text NOT NULL,
  estabelecimento_percentual numeric DEFAULT 85.00,
  estabelecimento_valor numeric NOT NULL,
  entregador_wallet_id text,
  entregador_recebe_taxa_entrega boolean DEFAULT true,
  entregador_taxa_entrega_valor numeric,
  entregador_percentual_extra numeric DEFAULT 0,
  entregador_valor_extra numeric DEFAULT 0,
  entregador_valor_total numeric NOT NULL,
  plataforma_percentual numeric DEFAULT 5.00,
  plataforma_valor numeric NOT NULL,
  plataforma_taxa_transacao numeric DEFAULT 0,
  status text DEFAULT 'pendente'::text,
  asaas_split_id text,
  asaas_response jsonb,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  processado_em timestamp with time zone,
  falhou_em timestamp with time zone,
  motivo_falha text,
  CONSTRAINT splits_pagamento_pkey PRIMARY KEY (id),
  CONSTRAINT splits_pagamento_pedido_id_fkey FOREIGN KEY (pedido_id) REFERENCES public.pedidos(id)
);
CREATE TABLE public.tbativo (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  num bigint NOT NULL DEFAULT 0,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  CONSTRAINT tbativo_pkey PRIMARY KEY (id)
);
CREATE TABLE public.usuarios (
  id uuid NOT NULL,
  email text NOT NULL UNIQUE,
  telefone text,
  tipo_usuario text NOT NULL CHECK (tipo_usuario = ANY (ARRAY['cliente'::text, 'entregador'::text, 'estabelecimento'::text, 'admin'::text])),
  status text DEFAULT 'ativo'::text,
  email_verificado boolean DEFAULT false,
  telefone_verificado boolean DEFAULT false,
  ultimo_login timestamp with time zone,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  updated_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  nome_completo_fantasia text NOT NULL DEFAULT ''::text,
  CONSTRAINT usuarios_pkey PRIMARY KEY (id),
  CONSTRAINT usuarios_id_fkey FOREIGN KEY (id) REFERENCES auth.users(id)
);