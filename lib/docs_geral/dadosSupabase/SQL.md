-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.administradores_estabelecimento (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  usuario_id uuid,
  estabelecimento_id uuid,
  nivel_permissao text NOT NULL DEFAULT 'gerente'::text CHECK (nivel_permissao = ANY (ARRAY['proprietario'::text, 'gerente'::text, 'operador'::text])),
  permissoes jsonb DEFAULT '{"ver_financeiro": true, "gerenciar_admins": false, "gerenciar_pedidos": true, "gerenciar_cardapio": true, "gerenciar_entregadores": true, "configuracoes_avancadas": false}'::jsonb,
  ativo boolean DEFAULT true,
  convite_pendente boolean DEFAULT true,
  convidado_por uuid,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  updated_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  CONSTRAINT administradores_estabelecimento_pkey PRIMARY KEY (id),
  CONSTRAINT administradores_estabelecimento_usuario_id_fkey FOREIGN KEY (usuario_id) REFERENCES public.usuarios(id),
  CONSTRAINT administradores_estabelecimento_estabelecimento_id_fkey FOREIGN KEY (estabelecimento_id) REFERENCES public.estabelecimentos(id),
  CONSTRAINT administradores_estabelecimento_convidado_por_fkey FOREIGN KEY (convidado_por) REFERENCES public.usuarios(id)
);
CREATE TABLE public.avaliacoes (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  pedido_id uuid NOT NULL UNIQUE,
  cliente_id uuid NOT NULL,
  estabelecimento_id uuid NOT NULL,
  entregador_id uuid,
  nota_estabelecimento numeric CHECK (nota_estabelecimento >= 1::numeric AND nota_estabelecimento <= 5::numeric),
  comentario_estabelecimento text,
  nota_entregador numeric CHECK (nota_entregador >= 1::numeric AND nota_entregador <= 5::numeric),
  comentario_entregador text,
  resposta_estabelecimento text,
  respondido_em timestamp with time zone,
  tags ARRAY DEFAULT '{}'::text[],
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT avaliacoes_pkey PRIMARY KEY (id),
  CONSTRAINT avaliacoes_pedido_fkey FOREIGN KEY (pedido_id) REFERENCES public.pedidos(id),
  CONSTRAINT avaliacoes_cliente_fkey FOREIGN KEY (cliente_id) REFERENCES public.clientes(id),
  CONSTRAINT avaliacoes_estabelecimento_fk FOREIGN KEY (estabelecimento_id) REFERENCES public.estabelecimentos(id),
  CONSTRAINT avaliacoes_entregador_fkey FOREIGN KEY (entregador_id) REFERENCES public.entregadores(id)
);
CREATE TABLE public.carrinhos (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  cliente_id uuid NOT NULL,
  estabelecimento_id uuid NOT NULL,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  updated_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  CONSTRAINT carrinhos_pkey PRIMARY KEY (id),
  CONSTRAINT carrinhos_cliente_fkey FOREIGN KEY (cliente_id) REFERENCES public.clientes(id),
  CONSTRAINT carrinhos_estabelecimento_fkey FOREIGN KEY (estabelecimento_id) REFERENCES public.estabelecimentos(id)
);
CREATE TABLE public.categorias (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  nome text NOT NULL UNIQUE,
  icone text,
  ativa boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  CONSTRAINT categorias_pkey PRIMARY KEY (id)
);
CREATE TABLE public.categorias_cardapio (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  estabelecimento_id uuid NOT NULL,
  nome text NOT NULL,
  descricao text,
  ordem_exibicao integer NOT NULL DEFAULT 0,
  ativa boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT categorias_cardapio_pkey PRIMARY KEY (id),
  CONSTRAINT categorias_cardapio_estabelecimento_fk FOREIGN KEY (estabelecimento_id) REFERENCES public.estabelecimentos(id)
);
CREATE TABLE public.categorias_estabelecimento (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  nome text NOT NULL UNIQUE,
  icone text,
  ativa boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  slug text NOT NULL UNIQUE,
  ordem_exibicao integer NOT NULL DEFAULT 0,
  imagem_url text,
  CONSTRAINT categorias_estabelecimento_pkey PRIMARY KEY (id)
);
CREATE TABLE public.clientes (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  usuario_id uuid UNIQUE,
  cpf text UNIQUE,
  data_nascimento date,
  foto_perfil_url text,
  preferencias jsonb DEFAULT '{"tema": "sistema", "notificacoes_push": true, "notificacoes_email": true}'::jsonb,
  total_pedidos integer DEFAULT 0,
  valor_total_gasto numeric DEFAULT 0,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  updated_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  indicado_por_cliente_id uuid,
  pontos_fidelidade integer DEFAULT 0,
  CONSTRAINT clientes_pkey PRIMARY KEY (id),
  CONSTRAINT clientes_usuario_id_fkey FOREIGN KEY (usuario_id) REFERENCES public.usuarios(id),
  CONSTRAINT clientes_indicado_por_cliente_id_fkey FOREIGN KEY (indicado_por_cliente_id) REFERENCES public.clientes(id)
);
CREATE TABLE public.config_despacho (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  estabelecimento_id uuid NOT NULL UNIQUE,
  tempo_resposta_seg integer NOT NULL DEFAULT 30,
  max_tentativas integer NOT NULL DEFAULT 10,
  raio_busca_inicial_km numeric NOT NULL DEFAULT 3.0,
  raio_busca_expansao_km numeric NOT NULL DEFAULT 1.5,
  raio_busca_maximo_km numeric NOT NULL DEFAULT 10.0,
  modo_despacho text NOT NULL DEFAULT 'automatico'::text CHECK (modo_despacho = ANY (ARRAY['automatico'::text, 'broadcast'::text, 'manual'::text])),
  prioridade_criterio text NOT NULL DEFAULT 'hibrido'::text CHECK (prioridade_criterio = ANY (ARRAY['distancia'::text, 'avaliacao'::text, 'score_fila'::text, 'hibrido'::text])),
  ativo boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT config_despacho_pkey PRIMARY KEY (id),
  CONSTRAINT config_despacho_estabelecimento_fk FOREIGN KEY (estabelecimento_id) REFERENCES public.estabelecimentos(id)
);
CREATE TABLE public.cupons (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  estabelecimento_id uuid,
  codigo text NOT NULL UNIQUE,
  descricao text,
  tipo text NOT NULL CHECK (tipo = ANY (ARRAY['percentual'::text, 'valor_fixo'::text, 'entrega_gratis'::text])),
  valor numeric NOT NULL CHECK (valor >= 0::numeric),
  valor_minimo_pedido numeric DEFAULT 0,
  limite_usos integer,
  usos_atuais integer DEFAULT 0,
  limite_usos_por_cliente integer DEFAULT 1,
  data_inicio timestamp with time zone DEFAULT now(),
  data_fim timestamp with time zone,
  ativo boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT cupons_pkey PRIMARY KEY (id),
  CONSTRAINT cupons_estabelecimento_id_fkey FOREIGN KEY (estabelecimento_id) REFERENCES public.estabelecimentos(id)
);
CREATE TABLE public.cupons_usos (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  cupom_id uuid NOT NULL,
  cliente_id uuid NOT NULL,
  pedido_id uuid NOT NULL,
  usado_em timestamp with time zone DEFAULT now(),
  CONSTRAINT cupons_usos_pkey PRIMARY KEY (id),
  CONSTRAINT cupons_usos_cupom_fkey FOREIGN KEY (cupom_id) REFERENCES public.cupons(id),
  CONSTRAINT cupons_usos_cliente_fkey FOREIGN KEY (cliente_id) REFERENCES public.clientes(id),
  CONSTRAINT cupons_usos_pedido_fkey FOREIGN KEY (pedido_id) REFERENCES public.pedidos(id)
);
CREATE TABLE public.despacho_pedidos (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  pedido_id uuid NOT NULL,
  entregador_id uuid NOT NULL,
  tentativa integer NOT NULL DEFAULT 1,
  status text NOT NULL DEFAULT 'aguardando'::text CHECK (status = ANY (ARRAY['aguardando'::text, 'aceito'::text, 'rejeitado'::text, 'expirado'::text, 'cancelado'::text])),
  distancia_km numeric,
  score_no_momento numeric,
  ofertado_em timestamp with time zone NOT NULL DEFAULT now(),
  expira_em timestamp with time zone NOT NULL,
  respondido_em timestamp with time zone,
  motivo_rejeicao text,
  push_enviado boolean DEFAULT false,
  push_enviado_em timestamp with time zone,
  metadata jsonb DEFAULT '{}'::jsonb,
  CONSTRAINT despacho_pedidos_pkey PRIMARY KEY (id),
  CONSTRAINT despacho_pedidos_pedido_fkey FOREIGN KEY (pedido_id) REFERENCES public.pedidos(id),
  CONSTRAINT despacho_pedidos_entregador_fk FOREIGN KEY (entregador_id) REFERENCES public.entregadores(id)
);
CREATE TABLE public.dispositivos_push (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  usuario_id uuid NOT NULL,
  token text NOT NULL UNIQUE,
  plataforma text NOT NULL CHECK (plataforma = ANY (ARRAY['android'::text, 'ios'::text, 'expo'::text])),
  app_version text,
  device_model text,
  ativo boolean DEFAULT true,
  invalido boolean DEFAULT false,
  invalido_em timestamp with time zone,
  motivo_invalido text,
  ultimo_uso_em timestamp with time zone DEFAULT now(),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT dispositivos_push_pkey PRIMARY KEY (id),
  CONSTRAINT dispositivos_push_usuario_fkey FOREIGN KEY (usuario_id) REFERENCES public.usuarios(id)
);
CREATE TABLE public.enderecos_clientes (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  cliente_id uuid,
  apelido text,
  cep text NOT NULL,
  logradouro text NOT NULL,
  numero text NOT NULL,
  complemento text,
  bairro text NOT NULL,
  cidade text NOT NULL,
  estado text NOT NULL,
  latitude numeric NOT NULL,
  longitude numeric NOT NULL,
  ponto_referencia text,
  instrucoes_entrega text,
  is_padrao boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  updated_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  geo USER-DEFINED,
  CONSTRAINT enderecos_clientes_pkey PRIMARY KEY (id),
  CONSTRAINT enderecos_clientes_cliente_id_fkey FOREIGN KEY (cliente_id) REFERENCES public.clientes(id)
);
CREATE TABLE public.entregadores (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  usuario_id uuid UNIQUE,
  cpf text NOT NULL UNIQUE,
  data_nascimento date,
  foto_perfil_url text,
  cnh_numero text UNIQUE,
  cnh_categoria text,
  cnh_validade date,
  cnh_foto_url text,
  tipo_veiculo text CHECK (tipo_veiculo = ANY (ARRAY['moto'::text, 'carro'::text, 'bicicleta'::text, 'van'::text])),
  veiculo_placa text,
  veiculo_modelo text,
  veiculo_cor text,
  veiculo_ano integer,
  veiculo_foto_url text,
  dados_bancarios jsonb DEFAULT '{"banco": null, "conta": null, "agencia": null, "pix_chave": null, "tipo_conta": null}'::jsonb,
  asaas_wallet_id text,
  asaas_account_id text,
  status_cadastro text DEFAULT 'pendente'::text,
  status_online boolean DEFAULT false,
  motivo_rejeicao text,
  raio_atuacao_km integer DEFAULT 10,
  aceita_pedidos_automaticamente boolean DEFAULT false,
  localizacao_atual jsonb,
  total_entregas integer DEFAULT 0,
  avaliacao_media numeric DEFAULT 5.0,
  total_avaliacoes integer DEFAULT 0,
  ganhos_total numeric DEFAULT 0,
  ganhos_disponiveis numeric DEFAULT 0,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  updated_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  latitude numeric,
  longitude numeric,
  status_despacho text NOT NULL DEFAULT 'livre'::text CHECK (status_despacho = ANY (ARRAY['livre'::text, 'aguardando_aceite'::text, 'em_pedido'::text])),
  pedido_atual_id uuid,
  ultima_entrega_em timestamp with time zone,
  score_fila numeric DEFAULT 0,
  geo USER-DEFINED,
  CONSTRAINT entregadores_pkey PRIMARY KEY (id),
  CONSTRAINT entregadores_usuario_id_fkey FOREIGN KEY (usuario_id) REFERENCES public.usuarios(id),
  CONSTRAINT entregadores_pedido_atual_id_fkey FOREIGN KEY (pedido_atual_id) REFERENCES public.pedidos(id)
);
CREATE TABLE public.estabelecimentos (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  usuario_id uuid,
  razao_social text,
  cnpj text UNIQUE,
  inscricao_estadual text,
  inscricao_municipal text,
  descricao text,
  logo_url text,
  banner_url text,
  fotos_estabelecimento ARRAY,
  telefone_comercial text,
  whatsapp text,
  email_comercial text,
  endereco jsonb NOT NULL,
  horario_funcionamento jsonb DEFAULT '{"dom": {"aberto": false}, "qua": {"fim": "20:00", "aberto": true, "inicio": "06:00"}, "qui": {"fim": "20:00", "aberto": true, "inicio": "06:00"}, "sab": {"fim": "19:00", "aberto": true, "inicio": "07:00"}, "seg": {"fim": "20:00", "aberto": true, "inicio": "06:00"}, "sex": {"fim": "20:00", "aberto": true, "inicio": "06:00"}, "ter": {"fim": "20:00", "aberto": true, "inicio": "06:00"}}'::jsonb,
  config_entrega jsonb DEFAULT '{"taxa_por_km": 2.00, "pedido_minimo": 15.00, "raio_maximo_km": 8, "gratis_acima_de": 50.00, "taxa_entrega_fixa": 5.00, "tempo_medio_preparo_min": 30}'::jsonb,
  asaas_wallet_id text,
  asaas_account_id text,
  status_cadastro text DEFAULT 'pendente'::text,
  status_aberto boolean DEFAULT false,
  motivo_suspensao text,
  documentos jsonb DEFAULT '{"contrato_social": null, "alvara_funcionamento": null, "comprovante_endereco": null}'::jsonb,
  total_pedidos integer DEFAULT 0,
  faturamento_total numeric DEFAULT 0,
  avaliacao_media numeric DEFAULT 5.0,
  total_avaliacoes integer DEFAULT 0,
  config_avancada jsonb DEFAULT '{"aceita_agendamento": false, "tempo_maximo_entrega_min": 60, "tempo_minimo_entrega_min": 15, "intervalo_atualizacao_estoque_min": 5, "tempo_antecedencia_agendamento_min": 60}'::jsonb,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  updated_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  responsavel_nome text,
  responsavel_cpf text,
  dados_bancarios jsonb DEFAULT '{"banco": null, "conta": null, "agencia": null, "titular": null, "tipo_conta": null, "conta_digito": null, "cpf_cnpj_titular": null}'::jsonb,
  latitude numeric,
  longitude numeric,
  categoria_estabelecimento_id uuid,
  geo USER-DEFINED,
  nome_fantasia text,
  slug text UNIQUE,
  tempo_medio_entrega_min integer DEFAULT 40,
  destaque boolean DEFAULT false,
  tags ARRAY DEFAULT '{}'::text[],
  CONSTRAINT estabelecimentos_pkey PRIMARY KEY (id),
  CONSTRAINT estabelecimentos_usuario_id_fkey FOREIGN KEY (usuario_id) REFERENCES public.usuarios(id),
  CONSTRAINT estabelecimentos_categoria_estabelecimento_id_fkey FOREIGN KEY (categoria_estabelecimento_id) REFERENCES public.categorias_estabelecimento(id)
);
CREATE TABLE public.historico_status_pedido (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  pedido_id uuid,
  status_anterior text,
  status_novo text NOT NULL,
  alterado_por uuid,
  motivo text,
  metadata jsonb,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  CONSTRAINT historico_status_pedido_pkey PRIMARY KEY (id),
  CONSTRAINT historico_status_pedido_pedido_id_fkey FOREIGN KEY (pedido_id) REFERENCES public.pedidos(id),
  CONSTRAINT historico_status_pedido_alterado_por_fkey FOREIGN KEY (alterado_por) REFERENCES public.usuarios(id)
);
CREATE TABLE public.itens_carrinho (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  carrinho_id uuid NOT NULL,
  produto_id uuid NOT NULL,
  quantidade integer NOT NULL DEFAULT 1 CHECK (quantidade > 0),
  preco_unitario numeric NOT NULL,
  opcoes_selecionadas jsonb DEFAULT '[]'::jsonb,
  observacao text,
  subtotal numeric DEFAULT ((quantidade)::numeric * preco_unitario),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT itens_carrinho_pkey PRIMARY KEY (id),
  CONSTRAINT itens_carrinho_carrinho_fkey FOREIGN KEY (carrinho_id) REFERENCES public.carrinhos(id),
  CONSTRAINT itens_carrinho_produto_fkey FOREIGN KEY (produto_id) REFERENCES public.produtos(id)
);
CREATE TABLE public.movimentacao_estoque (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  produto_id uuid NOT NULL,
  estabelecimento_id uuid NOT NULL,
  tipo_movimento text NOT NULL CHECK (tipo_movimento = ANY (ARRAY['entrada'::text, 'saida'::text, 'ajuste'::text, 'venda'::text, 'cancelamento'::text, 'desperdicio'::text])),
  quantidade integer NOT NULL,
  estoque_anterior integer,
  estoque_posterior integer,
  motivo text,
  pedido_id uuid,
  registrado_por uuid,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT movimentacao_estoque_pkey PRIMARY KEY (id),
  CONSTRAINT movimentacao_estoque_produto_fkey FOREIGN KEY (produto_id) REFERENCES public.produtos(id),
  CONSTRAINT movimentacao_estoque_estabelecimento_fk FOREIGN KEY (estabelecimento_id) REFERENCES public.estabelecimentos(id),
  CONSTRAINT movimentacao_estoque_pedido_fkey FOREIGN KEY (pedido_id) REFERENCES public.pedidos(id),
  CONSTRAINT movimentacao_estoque_usuario_fkey FOREIGN KEY (registrado_por) REFERENCES public.usuarios(id)
);
CREATE TABLE public.notificacao_preferencias (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  usuario_id uuid NOT NULL UNIQUE,
  push_ativo boolean DEFAULT true,
  push_pedidos boolean DEFAULT true,
  push_entregas boolean DEFAULT true,
  push_promocoes boolean DEFAULT true,
  silencioso_ativo boolean DEFAULT false,
  silencioso_inicio time without time zone DEFAULT '22:00:00'::time without time zone,
  silencioso_fim time without time zone DEFAULT '07:00:00'::time without time zone,
  silencioso_timezone text DEFAULT 'America/Sao_Paulo'::text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT notificacao_preferencias_pkey PRIMARY KEY (id),
  CONSTRAINT notificacao_preferencias_usuario_fkey FOREIGN KEY (usuario_id) REFERENCES public.usuarios(id)
);
CREATE TABLE public.notificacao_templates (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  evento text NOT NULL UNIQUE,
  titulo text NOT NULL,
  corpo text NOT NULL,
  icone text DEFAULT 'default'::text,
  som text DEFAULT 'default'::text,
  canal_android text DEFAULT 'geral'::text,
  dados_extras jsonb DEFAULT '{}'::jsonb,
  ativo boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT notificacao_templates_pkey PRIMARY KEY (id)
);
CREATE TABLE public.notificacoes_fila (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  usuario_id uuid NOT NULL,
  dispositivo_id uuid,
  evento text NOT NULL,
  titulo text NOT NULL,
  corpo text NOT NULL,
  dados jsonb DEFAULT '{}'::jsonb,
  entidade_tipo text,
  entidade_id uuid,
  status text NOT NULL DEFAULT 'pendente'::text CHECK (status = ANY (ARRAY['pendente'::text, 'processando'::text, 'enviado'::text, 'falhou'::text, 'ignorado'::text])),
  tentativas integer DEFAULT 0,
  max_tentativas integer DEFAULT 3,
  proxima_tentativa_em timestamp with time zone DEFAULT now(),
  provedor_response jsonb,
  provedor_message_id text,
  created_at timestamp with time zone DEFAULT now(),
  processado_em timestamp with time zone,
  enviado_em timestamp with time zone,
  falhou_em timestamp with time zone,
  erro_codigo text,
  erro_detalhe text,
  CONSTRAINT notificacoes_fila_pkey PRIMARY KEY (id),
  CONSTRAINT notificacoes_fila_dispositivo_fk FOREIGN KEY (dispositivo_id) REFERENCES public.dispositivos_push(id),
  CONSTRAINT notificacoes_fila_usuario_fkey FOREIGN KEY (usuario_id) REFERENCES public.usuarios(id)
);
CREATE TABLE public.notificacoes_historico (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  usuario_id uuid NOT NULL,
  dispositivo_id uuid,
  evento text NOT NULL,
  titulo text NOT NULL,
  corpo text NOT NULL,
  dados jsonb DEFAULT '{}'::jsonb,
  entidade_tipo text,
  entidade_id uuid,
  status text NOT NULL DEFAULT 'pendente'::text CHECK (status = ANY (ARRAY['pendente'::text, 'processando'::text, 'enviado'::text, 'falhou'::text, 'ignorado'::text])),
  tentativas integer DEFAULT 0,
  max_tentativas integer DEFAULT 3,
  proxima_tentativa_em timestamp with time zone DEFAULT now(),
  provedor_response jsonb,
  provedor_message_id text,
  created_at timestamp with time zone DEFAULT now(),
  processado_em timestamp with time zone,
  enviado_em timestamp with time zone,
  falhou_em timestamp with time zone,
  erro_codigo text,
  erro_detalhe text,
  arquivado_em timestamp with time zone DEFAULT now(),
  CONSTRAINT notificacoes_historico_pkey PRIMARY KEY (id)
);
CREATE TABLE public.pedidos (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  cliente_id uuid,
  estabelecimento_id uuid,
  entregador_id uuid,
  endereco_entrega_id uuid,
  status text DEFAULT 'pendente'::text CHECK (status = ANY (ARRAY['pendente'::text, 'confirmado'::text, 'preparando'::text, 'pronto'::text, 'em_entrega'::text, 'entregue'::text, 'cancelado_cliente'::text, 'cancelado_estab'::text, 'cancelado_sistema'::text])),
  itens jsonb NOT NULL,
  subtotal_produtos numeric NOT NULL,
  taxa_entrega numeric NOT NULL,
  taxa_servico_app numeric NOT NULL,
  desconto_cupom numeric DEFAULT 0,
  total numeric NOT NULL,
  endereco_entrega_snapshot jsonb NOT NULL,
  distancia_km numeric,
  tempo_estimado_preparo_min integer,
  tempo_estimado_entrega_min integer,
  asaas_payment_id text,
  asaas_invoice_url text,
  pagamento_metodo text CHECK (pagamento_metodo = ANY (ARRAY['pix'::text, 'cartao_credito'::text, 'cartao_debito'::text, 'boleto'::text, 'dinheiro'::text])),
  pagamento_status text DEFAULT 'pendente'::text,
  split_processado boolean DEFAULT false,
  localizacao_entregador jsonb,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  confirmado_em timestamp with time zone,
  preparando_em timestamp with time zone,
  pronto_em timestamp with time zone,
  em_entrega_em timestamp with time zone,
  entregue_em timestamp with time zone,
  cancelado_em timestamp with time zone,
  motivo_cancelamento text,
  avaliacao_cliente jsonb,
  avaliacao_entregador jsonb,
  updated_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  cupom_id uuid,
  numero_pedido bigint,
  CONSTRAINT pedidos_pkey PRIMARY KEY (id),
  CONSTRAINT pedidos_cliente_id_fkey FOREIGN KEY (cliente_id) REFERENCES public.clientes(id),
  CONSTRAINT pedidos_estabelecimento_id_fkey FOREIGN KEY (estabelecimento_id) REFERENCES public.estabelecimentos(id),
  CONSTRAINT pedidos_entregador_id_fkey FOREIGN KEY (entregador_id) REFERENCES public.entregadores(id),
  CONSTRAINT pedidos_endereco_entrega_id_fkey FOREIGN KEY (endereco_entrega_id) REFERENCES public.enderecos_clientes(id),
  CONSTRAINT pedidos_cupom_id_fkey FOREIGN KEY (cupom_id) REFERENCES public.cupons(id)
);
CREATE TABLE public.produtos (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  estabelecimento_id uuid,
  nome text NOT NULL,
  descricao text,
  preco numeric NOT NULL,
  preco_promocional numeric,
  custo_estimado numeric,
  foto_principal_url text,
  fotos_adicionais ARRAY,
  disponivel boolean DEFAULT true,
  destaque boolean DEFAULT false,
  opcoes jsonb DEFAULT '[]'::jsonb,
  controle_estoque boolean DEFAULT false,
  quantidade_estoque integer,
  tempo_preparo_adicional_min integer DEFAULT 0,
  total_vendidos integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  updated_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  categoria_id uuid,
  categoria_cardapio_id uuid,
  tipo_produto text NOT NULL DEFAULT 'simples'::text CHECK (tipo_produto = ANY (ARRAY['simples'::text, 'variavel'::text])),
  ativo boolean NOT NULL DEFAULT true,
  ordem_exibicao integer DEFAULT 0,
  slug text,
  peso_gramas integer,
  permite_observacao boolean NOT NULL DEFAULT true,
  CONSTRAINT produtos_pkey PRIMARY KEY (id),
  CONSTRAINT produtos_estabelecimento_id_fkey FOREIGN KEY (estabelecimento_id) REFERENCES public.estabelecimentos(id),
  CONSTRAINT produtos_categoria_id_fkey FOREIGN KEY (categoria_id) REFERENCES public.categorias(id),
  CONSTRAINT produtos_categoria_cardapio_id_fkey FOREIGN KEY (categoria_cardapio_id) REFERENCES public.categorias_cardapio(id)
);
CREATE TABLE public.rastreamento_entregadores (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  entregador_id uuid NOT NULL,
  pedido_id uuid,
  latitude numeric NOT NULL,
  longitude numeric NOT NULL,
  geo USER-DEFINED,
  velocidade_kmh numeric,
  bateria_pct integer,
  registrado_em timestamp with time zone DEFAULT now(),
  CONSTRAINT rastreamento_entregadores_pkey PRIMARY KEY (id),
  CONSTRAINT rastreamento_entregadores_entregador_fk FOREIGN KEY (entregador_id) REFERENCES public.entregadores(id),
  CONSTRAINT rastreamento_entregadores_pedido_fkey FOREIGN KEY (pedido_id) REFERENCES public.pedidos(id)
);
CREATE TABLE public.spatial_ref_sys (
  srid integer NOT NULL CHECK (srid > 0 AND srid <= 998999),
  auth_name character varying,
  auth_srid integer,
  srtext character varying,
  proj4text character varying,
  CONSTRAINT spatial_ref_sys_pkey PRIMARY KEY (srid)
);
CREATE TABLE public.splits_pagamento (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  pedido_id uuid UNIQUE,
  valor_total numeric NOT NULL,
  estabelecimento_wallet_id text NOT NULL,
  estabelecimento_percentual numeric DEFAULT 85.00,
  estabelecimento_valor numeric NOT NULL,
  entregador_wallet_id text,
  entregador_recebe_taxa_entrega boolean DEFAULT true,
  entregador_taxa_entrega_valor numeric,
  entregador_percentual_extra numeric DEFAULT 0,
  entregador_valor_extra numeric DEFAULT 0,
  entregador_valor_total numeric NOT NULL,
  plataforma_percentual numeric DEFAULT 5.00,
  plataforma_valor numeric NOT NULL,
  plataforma_taxa_transacao numeric DEFAULT 0,
  status text DEFAULT 'pendente'::text,
  asaas_split_id text,
  asaas_response jsonb,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  processado_em timestamp with time zone,
  falhou_em timestamp with time zone,
  motivo_falha text,
  CONSTRAINT splits_pagamento_pkey PRIMARY KEY (id),
  CONSTRAINT splits_pagamento_pedido_id_fkey FOREIGN KEY (pedido_id) REFERENCES public.pedidos(id)
);
CREATE TABLE public.tbativo (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  num bigint NOT NULL DEFAULT 0,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  CONSTRAINT tbativo_pkey PRIMARY KEY (id)
);
CREATE TABLE public.usuarios (
  id uuid NOT NULL,
  email text NOT NULL UNIQUE,
  telefone text,
  tipo_usuario text NOT NULL DEFAULT 'cliente'::text CHECK (tipo_usuario = ANY (ARRAY['cliente'::text, 'entregador'::text, 'estabelecimento'::text, 'admin'::text])),
  status text DEFAULT 'ativo'::text,
  email_verificado boolean DEFAULT false,
  telefone_verificado boolean DEFAULT false,
  ultimo_login timestamp with time zone,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  updated_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  nome_completo_fantasia text NOT NULL DEFAULT ''::text,
  CONSTRAINT usuarios_pkey PRIMARY KEY (id),
  CONSTRAINT usuarios_id_fkey FOREIGN KEY (id) REFERENCES auth.users(id)
);